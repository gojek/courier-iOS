# .github/workflows/ios-deployment.yml
name: ios-deployment

on:
  push:
    branches:
      - main
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

env:
  FASTLANE_SKIP_UPDATE_CHECK: true
  FASTLANE_HIDE_GITHUB_ISSUES: true
  FASTLANE_DISABLE_COLORS: false
  WORKING_DIRECTORY: courier-iOS

defaults:
  run:
    working-directory: courier-iOS

jobs:
  release:
    runs-on: macos-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Environment
        uses: ./.github/actions/setup_env

      - name: Install Dependencies
        uses: ./.github/actions/dependencies

      - name: Run SwiftLint
        uses: ./.github/actions/lint

      - name: Build targets
        run: bundle exec fastlane build_all_targets

      - name: Run tests
        uses: ./.github/actions/test

      - name: Bump version files
        run: bundle exec fastlane bump_version_files

      - name: Generate MQTTClientGJ.xcframework
        run: bundle exec fastlane generate_mqttclientgj_xcf

      - name: Commit version bump
        run: bundle exec fastlane bump_version_commit

      - name: Publish podspecs
        run: |
          pod trunk push --allow-warnings MQTTClientGJ.podspec
          pod trunk push --allow-warnings CourierCore.podspec
          pod trunk push --allow-warnings --synchronous CourierMQTT.podspec
          pod trunk push --allow-warnings --synchronous CourierProtobuf.podspec
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}

  post_release:
    runs-on: ubuntu-latest
    needs: release
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v3
        with:
          node-version: '20.x'

      - name: Build website
        run: |
          cd docs
          yarn install --frozen-lockfile
          yarn build

      - name: Release to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/build
          user_name: github-actions[bot]
          user_email: 41898282+github-actions[bot]@users.noreply.github.com

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          body_path: ${{ github.workspace }}/CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
