# .github/workflows/deployment.yml
name: deployment

on:
  push:
    branches:
      - main
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

env:
  FASTLANE_SKIP_UPDATE_CHECK: true
  FASTLANE_HIDE_GITHUB_ISSUES: true
  FASTLANE_DISABLE_COLORS: false
  GIT_AUTHOR_NAME: "github-actions[bot]"
  GIT_AUTHOR_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"
  GIT_COMMITTER_NAME: "github-actions[bot]"
  GIT_COMMITTER_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"

jobs:
  release:
    runs-on: macos-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "${{ env.GIT_AUTHOR_NAME }}"
          git config user.email "${{ env.GIT_AUTHOR_EMAIL }}"
          git config user.name "${{ env.GIT_COMMITTER_NAME }}"
          git config user.email "${{ env.GIT_COMMITTER_EMAIL }}"

      - name: Setup Environment
        uses: ./.github/actions/setup_env

      - name: Bump version files
        run: bundle exec fastlane bump_version_files

      - name: Generate MQTTClientGJ.xcframework
        run: bundle exec fastlane generate_mqttclientgj_xcf

      - name: Generate CHANGELOG.md
        run: bundle exec fastlane update_changelog

      - name: Commit version bump
        run: bundle exec fastlane commit_push
        env:
          COURIER_IOS_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish podspecs
        run: |
          pod trunk push --allow-warnings MQTTClientGJ.podspec
          pod trunk push --allow-warnings CourierCore.podspec
          pod trunk push --allow-warnings --synchronous CourierMQTT.podspec
          pod trunk push --allow-warnings --synchronous CourierProtobuf.podspec
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}

  post_release:
    runs-on: ubuntu-latest
    needs: release
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - uses: actions/setup-node@v3
        with:
          node-version: '20.x'

      - name: Build website
        run: |
          cd docs
          yarn install --frozen-lockfile
          yarn build

      - name: Release to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/build
          user_name: "${{ env.GIT_COMMITTER_NAME }}"
          user_email: "${{ env.GIT_COMMITTER_EMAIL }}"

      - name: Extract changelog for current version
        id: changelog
        run: |
          VERSION=${{ github.ref_name }}
          CHANGELOG=$(awk "/## \[$VERSION\]/,/## \[/" CHANGELOG.md | sed '$d')
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          body: ${{ steps.changelog.outputs.notes }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
